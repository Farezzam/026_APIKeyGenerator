<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');

        body {
            font-family: "Poppins", sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            background: linear-gradient(135deg, #4b6cb7, #182848);
            display: flex;
            justify-content: center;
            padding: 40px 20px;
        }

        /* Container Card */
        .dashboard-container {
            width: 100%;
            max-width: 1100px;
            background: #ffffffd9;
            backdrop-filter: blur(10px);
            padding: 30px 40px;
            border-radius: 18px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.25);
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Header */
        .dash-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        h2 {
            margin: 0;
            color: #182848;
            font-size: 28px;
            font-weight: 700;
        }

        /* Buttons */
        button {
            border: none;
            padding: 10px 15px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: 0.25s;
        }

        button:hover {
            transform: scale(1.04);
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }

        .btn-danger { background: linear-gradient(135deg, #dc3545, #b52a36); color: white; }
        .btn-primary { background: linear-gradient(135deg, #007bff, #005fcc); color: white; }
        .btn-warning { background: linear-gradient(135deg, #ffc107, #f0a400); color: black; }
        .btn-success { background: linear-gradient(135deg, #28a745, #1e7e34); color: white; }
        .btn-secondary { background: #6c757d; color: white; }

        hr {
            border: none;
            height: 1px;
            background: #e0e0e0;
            margin: 18px 0;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 12px;
            background: white;
            border-radius: 14px;
            overflow: hidden;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }

        th {
            padding: 14px;
            text-align: left;
            background: #f4f6fb;
            font-size: 15px;
            border-bottom: 1px solid #ddd;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #eee;
            vertical-align: top;
        }

        tr:hover td {
            background: #f8f9ff;
        }

        td.actions {
            min-width: 280px;
            text-align: right;
        }

        ul { padding-left: 20px; margin: 0; }
        li { margin-bottom: 5px; font-size: 14px; }

        .status-active { color: #28a745; font-weight: 600; }
        .status-inactive { color: #dc3545; font-weight: 600; }

        #usersList, #apiKeysList {
            margin-top: 25px;
        }
    </style>
</head>

<body>
    <div class="dashboard-container">
        <div class="dash-header">
            <h2>Admin Dashboard</h2>
            <button id="btnLogout" class="btn-danger">Logout</button>
        </div>

        <hr>

        <button id="btnGetUsers" class="btn-primary">Refresh List Users</button>
        <button id="btnGetApiKeys" class="btn-primary">Refresh List API Keys</button>

        <div id="usersList"></div>
        <div id="apiKeysList"></div>
    </div>

    <script>
        /* ————— SCRIPT ASLI TETAP SAMA ————— */

        let authToken = localStorage.getItem('adminToken');
        if (!authToken) window.location.href = '/admin-login-page';

        async function fetchProtected(url, options = {}) {
            if (!options.headers) options.headers = {};
            options.headers['Authorization'] = `Bearer ${authToken}`;
            if (options.body) options.headers['Content-Type'] = 'application/json';

            const res = await fetch(url, options);
            if (res.status === 401 || res.status === 403) {
                localStorage.removeItem('adminToken');
                window.location.href = '/admin-login-page';
                return null;
            }
            return res;
        }

        document.getElementById('btnGetUsers').addEventListener('click', loadUsers);
        async function loadUsers() {
            const res = await fetchProtected('/api/admin/users');
            const users = await res.json();
            renderUserTable(users);
        }

        function renderUserTable(users) {
            const listEl = document.getElementById('usersList');
            if (!users || users.length === 0) {
                listEl.innerHTML = '<h3>Tidak ada user.</h3>';
                return;
            }

            let html = `
                <h3>List Users</h3>
                <table>
                    <tr>
                        <th>ID</th><th>Email</th><th>Name</th><th>API Keys</th><th class="actions">Actions</th>
                    </tr>
            `;

            users.forEach(user => {
                let apiKeys = '<em>No keys</em>';

                if (user.apikeys?.length) {
                    apiKeys = `<ul>${user.apikeys.map(k => `
                        <li>${k.key.substring(0,8)}...
                            <span class="${k.outofdate ? 'status-inactive' : 'status-active'}">
                                (${k.outofdate ? 'Inactive' : 'Active'})
                            </span>
                        </li>
                    `).join('')}</ul>`;
                }

                html += `
                    <tr>
                        <td>${user.id}</td>
                        <td>${user.email}</td>
                        <td>${user.firstname} ${user.lastname}</td>
                        <td>${apiKeys}</td>
                        <td class="actions">
                            <button class="btn-success" onclick="generateKeyForUser(${user.id})">Generate Key</button>
                            <button class="btn-warning" onclick="editUser(${user.id}, '${user.email}', '${user.firstname}', '${user.lastname}')">Edit</button>
                            <button class="btn-danger" onclick="deleteUser(${user.id})">Delete</button>
                        </td>
                    </tr>
                `;
            });

            html += `</table>`;
            listEl.innerHTML = html;
        }

        function editUser(id, email, firstname, lastname) {
            alert("Fitur edit user masih aktif.\nIngin dihapus? Bilang saja.");
        }

        async function deleteUser(id) {
            if (!confirm("Hapus user?")) return;
            const res = await fetchProtected(`/api/admin/users/${id}`, { method: 'DELETE' });
            const data = await res.json();
            alert(data.message);
            loadUsers();
            loadApiKeys();
        }

        async function generateKeyForUser(id) {
            if (!confirm("Generate key baru?")) return;
            const res = await fetchProtected(`/api/admin/users/${id}/keys`, { method: 'POST' });
            const data = await res.json();
            alert("Key Baru:\n" + data.apiKey.key);
            loadUsers();
            loadApiKeys();
        }

        document.getElementById('btnGetApiKeys').addEventListener('click', loadApiKeys);
        async function loadApiKeys() {
            const res = await fetchProtected('/api/admin/apikeys');
            const keys = await res.json();
            renderApiKeysTable(keys);
        }

        function renderApiKeysTable(keys) {
            const listEl = document.getElementById('apiKeysList');
            if (!keys || keys.length === 0) {
                listEl.innerHTML = '<h3>Tidak ada API key.</h3>';
                return;
            }

            let html = `
                <h3>List API Keys</h3>
                <table>
                    <tr>
                        <th>ID</th><th>Key</th><th>User Email</th><th>Status</th><th class="actions">Actions</th>
                    </tr>
            `;

            keys.forEach(k => {
                html += `
                    <tr>
                        <td>${k.key_id}</td>
                        <td>${k.key.substring(0, 18)}...</td>
                        <td>${k.user_email}</td>
                        <td>${k.status_inactive}</td>
                        <td class="actions">
                            ${k.status_inactive === 'Active'
                                ? `<button class="btn-warning" onclick="setKeyStatus(${k.key_id}, true)">Deactivate</button>`
                                : `<button class="btn-success" onclick="setKeyStatus(${k.key_id}, false)">Activate</button>`
                            }
                            <button class="btn-danger" onclick="deleteApiKey(${k.key_id})">Delete</button>
                        </td>
                    </tr>
                `;
            });

            html += `</table>`;
            listEl.innerHTML = html;
        }

        async function setKeyStatus(keyId, setOutOfDate) {
            if (!confirm("Ubah status key?")) return;
            const res = await fetchProtected(`/api/admin/apikeys/${keyId}`, {
                method: "PUT",
                body: JSON.stringify({ outofdate: setOutOfDate })
            });
            const data = await res.json();
            alert(data.message);
            loadApiKeys();
            loadUsers();
        }

        async function deleteApiKey(keyId) {
            if (!confirm("Hapus API key?")) return;
            const res = await fetchProtected(`/api/admin/apikeys/${keyId}`, { method: 'DELETE' });
            const data = await res.json();
            alert(data.message);
            loadApiKeys();
            loadUsers();
        }

        document.getElementById('btnLogout').addEventListener('click', () => {
            localStorage.removeItem('adminToken');
            window.location.href = '/admin-login-page';
        });

        loadUsers();
        loadApiKeys();
    </script>
</body>
</html>
